# 回测系统使用说明

## 📋 概述

这是一个基于**规则引擎 + 离线分析**的快速回测系统，用于测试交易策略和提示词的有效性。

### 特点
- ✅ **不消耗Token**：使用规则引擎代替AI，快速验证硬性规则
- ✅ **快速分析**：按时间顺序批量处理历史数据，不等待真实时间
- ✅ **详细统计**：统计规则有效性、wait原因、错过的机会等
- ✅ **完整报告**：生成详细的测试报告

---

## 🚀 快速开始

### 1. 运行回测

```bash
# 使用默认参数（最近7天）
go run backtest/main.go

# 指定时间范围
go run backtest/main.go -start '2024-11-01 00:00:00' -end '2024-11-30 23:59:59'

# 指定币种和输出路径
go run backtest/main.go -start '2024-11-01 00:00:00' -end '2024-11-30 23:59:59' -symbols 'BTCUSDT,ETHUSDT' -output 'my_report.txt'
```

### 2. 查看报告

报告会保存在指定的输出路径（默认：`backtest_report.txt`），包含：
- 总体统计（总周期数、wait率、开仓率等）
- Top 10 Wait原因
- Top 10 规则失败
- 按币种统计
- 错过的机会统计
- 分析结论

---

## 📊 报告示例

```
═══════════════════════════════════════════════════════════════
           策略测试报告（规则引擎 + 离线分析）
═══════════════════════════════════════════════════════════════

【总体统计】
总周期数: 14400
总决策数: 28800
Wait决策数: 25920 (90.00%)
开仓决策数: 2880 (10.00%)

【Top 10 Wait原因】
1. 持仓数已达上限（当前持仓3个，待成交限价单0个，总计3个）: 7200次 (27.78%)
2. momentum_15m不符合做多要求，当前为neutral: 5400次 (20.83%)
3. to_boll_upper_15m_pct <= 5%，当前为2.34%: 3600次 (13.89%)
...

【分析结论】
⚠️  开仓严格程度: 非常高（wait率>90%），可能过于严格，错过很多机会
```

---

## 🔧 架构说明

### 1. 规则引擎 (`rule_engine.go`)

提取并实现所有硬性规则：
- 持仓数量限制
- Late阶段Gate
- 动能方向确认
- 距离布林带确认
- 关键位突破确认
- 极端波动禁止开仓
- 等等

### 2. 离线分析器 (`offline_analyzer.go`)

按时间顺序分析历史数据：
- 加载历史K线数据
- 按时间顺序处理所有周期（每3分钟）
- 对每个币种尝试开多/开空
- 使用规则引擎生成决策
- 记录所有决策和失败原因

### 3. 统计分析 (`statistics.go`)

统计各种指标：
- 总体统计（wait率、开仓率等）
- 按币种统计
- 按时间段统计
- Wait原因统计
- 规则失败统计
- 错过的机会统计

### 4. 报告生成 (`report.go`)

生成详细的测试报告：
- 总体统计
- Top Wait原因
- Top 规则失败
- 按币种统计
- 错过的机会
- 分析结论

---

## 📝 注意事项

### 1. 历史数据获取

当前实现使用 `market.Get()` 获取当前市场数据。实际回测时，应该：
- 从Binance API获取历史K线数据
- 按时间顺序组织数据
- 为每个时间点计算技术指标

### 2. 规则完整性

当前规则引擎只实现了部分硬性规则。完整实现应该包括：
- 所有 `CoreTradingRules` 中的规则
- 所有 `DecisionChecklist` 中的检查
- 所有 `OpenSetup` 中的要求

### 3. 决策生成

当前决策生成是简化版，只检查硬性规则。完整实现应该：
- 评估机会等级
- 计算TP概率和R:R
- 生成完整的开仓决策（包括止损、止盈、仓位大小等）

---

## 🎯 使用场景

### 1. 快速验证规则有效性

```bash
# 测试最近1个月的数据
go run backtest/main.go -start '2024-11-01 00:00:00' -end '2024-11-30 23:59:59'
```

### 2. 测试开仓严格程度

查看报告中的wait率：
- wait率>90%：可能过于严格
- wait率70-90%：可能偏严格
- wait率50-70%：较为合理
- wait率<50%：较为宽松

### 3. 找出规则问题

查看Top Wait原因和Top 规则失败，找出：
- 哪些规则触发最频繁
- 哪些规则可能过于严格
- 哪些规则需要优化

### 4. 分析错过的机会

查看"错过的机会统计"，分析：
- 哪些机会被规则过滤掉了
- 如果放宽某些规则，会如何
- 哪些规则需要调整

---

## 🔄 后续优化

### 1. 历史数据支持

实现真正的历史数据获取：
- 从Binance API获取历史K线
- 缓存历史数据到本地
- 按时间顺序组织数据

### 2. 完整规则实现

实现所有硬性规则：
- TP概率和R:R检查
- 止损距离检查
- 15m反向动能禁入锁
- 急跌/急涨后反弹场景检查
- 等等

### 3. 决策生成优化

优化决策生成逻辑：
- 更准确的机会等级评估
- 更准确的TP概率计算
- 更准确的R:R计算
- 更完整的开仓决策

### 4. 可视化

添加可视化功能：
- 权益曲线图
- Wait原因分布图
- 规则失败分布图
- 按时间段统计图

---

## 📚 相关文档

- `BACKTEST_DESIGN.md`：回测系统设计方案
- `BACKTEST_FAST_METHODS.md`：快速回测方法
- `FAST_STRATEGY_TEST_METHODS.md`：快速测试提示词与策略的方法

---

**创建时间**：2025-01-XX  
**状态**：✅ 基础功能已完成，可以开始使用

