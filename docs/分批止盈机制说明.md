# 分批止盈机制说明

## 概述

系统实现了**双重分批止盈机制**：
1. **自动分批止盈**：系统自动检测 TP1/TP2/TP3 到达，自动执行分批平仓和抬止损
2. **AI 主动分批止盈**：AI 可以通过 `close_long`/`close_short` + `close_ratio`/`close_quantity` 主动进行部分平仓

---

## 一、提示词层面（OutputProtocol 模块）

### 1.1 部分平仓字段定义

在 `prompts/modules/OutputProtocol.txt` 中定义了部分平仓的字段：

```json
{
  "action": "close_long" 或 "close_short",
  "close_quantity": 0.5,    // 本次实际要平掉的合约数量（优先级最高）
  "close_ratio": 0.33,      // 或使用比例：0-1 或 0-100 的百分比
  "reasoning": "..."
}
```

**字段说明**：
- `close_quantity`：直接指定本次要平掉的合约数量（优先级最高）
- `close_ratio`：按当前持仓数量的比例平仓
  - 0-1 范围：例如 `0.33` 表示平掉 33%
  - 0-100 范围：例如 `33` 表示平掉 33%（系统会自动转换）
- 若两者都未提供，系统按**全平**处理

### 1.2 部分止盈模板建议

**到达 TP1（多单示例）**：
```json
{
  "action": "close_long",
  "close_ratio": 0.33,  // 或 33
  "reasoning": "15m 首次触达 TP1，短期多头动能仍在，先部分止盈约 1/3 仓位锁定利润，剩余仓位继续博弈 TP2/TP3，若15m结构转弱将抬高止损保护浮盈。"
}
```

**到达 TP2（多单示例）**：
```json
{
  "action": "close_long",
  "close_ratio": 0.5,  // 平掉剩余仓位的 50%
  "reasoning": "价格到达 TP2，4h/1h 多头结构仍成立但短周期动能放缓，二次分批止盈约 50% 剩余仓位，降低回撤风险，保留少量仓位继续博弈 TP3。"
}
```

**空单同理**：使用 `close_short` + `close_ratio`

---

## 二、后端实现层面

### 2.1 数据结构

**PositionTarget 结构体**（`trader/auto_trader.go`）：
```go
type PositionTarget struct {
    TP1       float64 `json:"tp1"`        // 第一止盈点
    TP2       float64 `json:"tp2"`        // 第二止盈点
    TP3       float64 `json:"tp3"`        // 第三止盈点
    Stage     int     `json:"stage"`      // 当前阶段：0=还没到tp1, 1=到过tp1, 2=到过tp2, 3=到过tp3
    CurrentSL float64 `json:"current_sl"` // 当前已生效的止损价
}
```

**存储位置**：
- 使用 `map[string]*PositionTarget` 存储，key 格式：`"BTCUSDT_long"` 或 `"ETHUSDT_short"`

### 2.2 自动分批止盈机制

**核心函数**：`autoCheckAndUpdateStopLoss()`（`trader/auto_trader.go:538`）

**执行流程**：
1. 每个交易周期自动检测所有持仓
2. 通过 `computeTrailingSL()` 计算是否到达 TP1/TP2/TP3
3. 如果到达新的阶段，执行分批平仓和抬止损

**TP 到达判断逻辑**（`computeTrailingSL()`）：
```go
// 多单
if lastPrice >= tgt.TP1 && tgt.Stage < 1 {
    // 到达 TP1
    newStage = 1
    newSL = entry  // 抬止损到开仓价（保本）
}

if lastPrice >= tgt.TP2 && tgt.Stage < 2 {
    // 到达 TP2
    newStage = 2
    newSL = (entry + tgt.TP1) / 2  // 抬止损到 (entry+TP1)/2
}

if lastPrice >= tgt.TP3 && tgt.Stage < 3 {
    // 到达 TP3
    newStage = 3
    newSL = (tgt.TP1 + tgt.TP2) / 2  // 抬止损到 (TP1+TP2)/2
}

// 空单同理，方向相反
```

**分批平仓规则**：
```go
switch newStage {
case 1: // 到达 TP1：平掉 1/4 仓位
    partialCloseQty = qty * (1.0 / 4.0)
    partialCloseRatio = "1/4"
    
case 2: // 到达 TP2：再平 1/3（剩余仓位的 1/3）
    partialCloseQty = qty * (1.0 / 3.0)
    partialCloseRatio = "1/3 剩余"
    
case 3: // 到达 TP3：交易所的止盈单会自动平掉全部
    // 不需要手动平仓，TP3止盈单会自动触发
}
```

**抬止损规则**：
- **TP1 →** 止损抬至开仓价（保本）
- **TP2 →** 止损抬至 `(开仓价 + TP1) / 2`
- **TP3 →** 止损抬至 `(TP1 + TP2) / 2`

### 2.3 AI 主动分批止盈

**实现位置**：`executeCloseLong()` / `executeCloseShort()`（`trader/auto_trader.go:1430+`）

**计算逻辑**：
```go
// 1) 优先使用 close_quantity
if decision.CloseQuantity > 0 {
    closeQty = decision.CloseQuantity
} 
// 2) 否则使用 close_ratio
else if decision.CloseRatio > 0 {
    if decision.CloseRatio > 1 {
        // 容错：如果AI给的是百分比（例如 33），转换为 0.33
        closeQty = currentQty * (decision.CloseRatio / 100.0)
    } else {
        closeQty = currentQty * decision.CloseRatio
    }
}
// 3) 若两者都未提供，按全平处理
else {
    closeQty = 0  // 0 = 全部平仓
}
```

**容错保护**：
- 若计算出的数量 ≤ 0 或 ≥ 当前仓位，则退回全平语义
- 平仓成功后，会从 `positionTargets` 中删除该持仓记录（如果全平）

---

## 三、两种机制的关系

### 3.1 自动机制 vs AI 主动机制

| 特性 | 自动分批止盈 | AI 主动分批止盈 |
|------|------------|----------------|
| **触发时机** | 系统自动检测 TP1/TP2/TP3 到达 | AI 根据市场情况主动决策 |
| **执行频率** | 每个交易周期（如 3 分钟） | AI 决策时 |
| **平仓比例** | 固定：TP1 平 1/4，TP2 平 1/3 剩余 | 灵活：AI 可自定义比例 |
| **抬止损** | 自动按规则抬止损 | 需要 AI 主动发 `update_stop_loss` |
| **适用场景** | 正常到达 TP 点 | 提前止盈、风险控制、极端介入 |

### 3.2 配合使用

**最佳实践**：
1. **正常情况**：依赖自动分批止盈机制，让系统自动处理 TP1/TP2/TP3
2. **特殊情况**：AI 根据市场变化主动部分平仓
   - 接近 TP1/TP2 但反转概率增加
   - 出现强反转信号但未到 TP
   - 极端介入场景

**注意事项**：
- AI **不应该**在到达 TP1/TP2/TP3 时重复发 `update_stop_loss`（系统已自动处理）
- AI **可以**在到达 TP 前主动部分平仓，但需要说明理由
- 如果 AI 主动全平，系统会删除 `positionTargets` 记录

---

## 四、完整流程示例

### 4.1 自动分批止盈流程

**场景**：BTCUSDT 多单，开仓价 50000，TP1=51000，TP2=52000，TP3=53000

1. **开仓时**：
   ```go
   positionTargets["BTCUSDT_long"] = &PositionTarget{
       TP1: 51000,
       TP2: 52000,
       TP3: 53000,
       Stage: 0,
       CurrentSL: 49000,  // 初始止损
   }
   ```

2. **价格到达 51000（TP1）**：
   - 系统检测到 `lastPrice >= TP1 && Stage < 1`
   - 执行：平仓 1/3 + 抬止损到 50000（开仓价）
   - 更新：`Stage = 1`, `CurrentSL = 50000`

3. **价格到达 52000（TP2）**：
   - 系统检测到 `lastPrice >= TP2 && Stage < 2`
   - 执行：平仓剩余仓位的 1/2（即再平 1/3，总共平了 2/3）+ 抬止损到 50500（(50000+51000)/2）
   - 更新：`Stage = 2`, `CurrentSL = 50500`

4. **价格到达 53000（TP3）**：
   - 系统检测到 `lastPrice >= TP3 && Stage < 3`
   - 执行：交易所止盈单自动平掉全部剩余仓位 + 抬止损到 51500（(51000+52000)/2）
   - 更新：`Stage = 3`, `CurrentSL = 51500`

### 4.2 AI 主动分批止盈流程

**场景**：价格接近 TP1 但出现反转信号，AI 决定提前部分平仓

```json
{
  "action": "close_long",
  "symbol": "BTCUSDT",
  "close_ratio": 0.25,
  "reasoning": "价格接近 TP1 但 4h 出现反向 BOS，1h RSI 背离，反转概率提升至 40%，提前平仓 25% 锁定部分利润，剩余仓位继续持有但提高警惕。"
}
```

**后端处理**：
1. 计算平仓数量：`closeQty = currentQty * 0.25`
2. 执行平仓：`trader.CloseLong("BTCUSDT", closeQty)`
3. 更新持仓数量（但不删除 `positionTargets` 记录）
4. 后续仍可继续使用自动分批止盈机制

---

## 五、关键代码位置

### 5.1 提示词相关
- `prompts/modules/OutputProtocol.txt:37-57`：部分止盈模板和建议

### 5.2 后端实现
- `trader/auto_trader.go:17-24`：PositionTarget 结构体定义
- `trader/auto_trader.go:538-687`：`autoCheckAndUpdateStopLoss()` 自动分批止盈
- `trader/auto_trader.go:1095-1163`：`computeTrailingSL()` TP 到达判断
- `trader/auto_trader.go:1430-1480`：`executeCloseLong()` AI 主动平仓（多单）
- `trader/auto_trader.go:1540-1590`：`executeCloseShort()` AI 主动平仓（空单）

### 5.3 决策结构
- `decision/engine.go:135-136`：Decision 结构体中的 `CloseQuantity` 和 `CloseRatio` 字段

---

## 六、注意事项

### 6.1 提示词约束
- **禁止重复抬止损**：AI 不应该在到达 TP1/TP2/TP3 时发 `update_stop_loss`（系统已自动处理）
- **建议优先分批**：提示词建议优先采用分批平仓而不是一次性全平
- **必须说明理由**：使用部分平仓时，reasoning 必须包含 TP 概率、反转概率、风险提示

### 6.2 后端约束
- **安全间隔检查**：止损与市价必须保持至少 0.05% 的间隔
- **阶段递增**：Stage 只能递增，不能回退
- **容错处理**：如果平仓数量计算异常，会退回全平语义

### 6.3 数据一致性
- 平仓后需要重新获取最新持仓数量
- 全平后需要删除 `positionTargets` 记录
- TP3 到达后，剩余仓位由交易所止盈单自动处理

---

## 七、总结

分批止盈机制提供了**双重保障**：
1. **自动化**：系统自动检测和执行，减少人工干预
2. **灵活性**：AI 可以根据市场情况主动调整

**核心优势**：
- ✅ 锁定利润：分批平仓可以逐步锁定利润
- ✅ 保护收益：抬止损机制保护已实现的利润
- ✅ 灵活应对：AI 可以根据市场变化主动调整
- ✅ 风险控制：避免一次性全平导致错失后续机会

**使用建议**：
- 正常情况依赖自动机制
- 特殊情况 AI 主动干预
- 两者配合使用，实现最佳风险收益比

